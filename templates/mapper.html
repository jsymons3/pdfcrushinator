<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Map Editor â€” Agent Assist</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <style>
    :root {
      --bg-primary: #fafafa;
      --bg-panel: #ffffff;
      --border: #e5e5e5;
      --accent: #06b6d4;
      --text: #1a1a1a;
      --highlight: #ec4899;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'DM Sans', sans-serif;
      margin: 0;
      background: var(--bg-primary);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Prevent body scroll */
    }

    /* Toolbar */
    .toolbar {
      height: 60px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
      z-index: 100;
    }
    .title { font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 10px; }
    .zoom-controls { display: flex; gap: 5px; background: #f1f5f9; padding: 4px; border-radius: 6px; }
    .btn-icon { width: 28px; height: 28px; border: none; background: white; border-radius: 4px; cursor: pointer; font-weight: bold; color: #555; }
    .btn-icon:hover { background: #e2e8f0; }

    .btn {
      padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer;
      background: var(--accent); color: white; font-size: 14px;
    }
    .btn:hover { opacity: 0.9; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); margin-right: 10px; }

    /* Main Layout */
    .main {
      display: flex;
      flex: 1;
      height: calc(100vh - 60px); /* Exact height minus toolbar */
      overflow: hidden;
    }

    /* PDF Viewer Side */
    .pdf-container {
      flex: 1;
      background: #525659;
      overflow: auto; /* Enable Scroll */
      position: relative;
      padding: 40px;
      text-align: center;
    }

    .pdf-page-wrapper {
      position: relative;
      display: inline-block; /* Allows centering */
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      margin-bottom: 20px;
      background: white;
      vertical-align: top;
    }

    /* Overlay Boxes */
    .field-box {
      position: absolute;
      border: 2px solid rgba(236, 72, 153, 0.5);
      background: rgba(236, 72, 153, 0.1);
      cursor: pointer;
      transition: all 0.1s;
      z-index: 5;
    }
    .field-box:hover {
      border-color: var(--highlight);
      background: rgba(236, 72, 153, 0.25);
      z-index: 20;
    }
    .field-box.active {
      border-color: var(--highlight);
      background: rgba(236, 72, 153, 0.4);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8), 0 0 10px rgba(236, 72, 153, 0.5);
      z-index: 20;
    }
    .field-badge {
      position: absolute;
      top: -16px; left: -2px;
      background: var(--highlight);
      color: white;
      font-size: 11px;
      padding: 2px 5px;
      border-radius: 3px;
      font-weight: bold;
      pointer-events: none;
    }

    /* Editor Sidebar */
    .sidebar {
      width: 400px;
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      height: 100%;
      flex-shrink: 0;
      z-index: 50;
    }
    .sidebar-header {
      padding: 15px; border-bottom: 1px solid var(--border); background: #f8fafc;
      font-size: 13px; color: #64748b;
    }
    .fields-list {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      list-style: none;
      margin: 0;
    }
    .field-item {
      padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer;
      transition: background 0.1s;
    }
    .field-item:hover { background: #f8fafc; }
    .field-item.active {
      background: #f0fdfa;
      border-left: 4px solid var(--accent);
    }

    .field-meta { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; }
    .field-id { font-family: 'JetBrains Mono', monospace; background: #e2e8f0; color: #475569; padding: 1px 6px; border-radius: 3px; }

    .field-label { font-size: 13px; font-weight: 600; color: #334155; margin-bottom: 8px; line-height: 1.4; }

    textarea.field-input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
      min-height: 70px;
      background: #fff;
    }
    textarea.field-input:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.1);
    }
  </style>
</head>
<body>

<div class="toolbar">
  <div class="title">
    <span>Map Editor</span>
    <div class="zoom-controls">
      <button class="btn-icon" onclick="changeZoom(-0.2)">-</button>
      <button class="btn-icon" onclick="resetZoom()">100%</button>
      <button class="btn-icon" onclick="changeZoom(0.2)">+</button>
    </div>
  </div>
  <div>
    <button class="btn btn-outline" onclick="window.close()">Close</button>
    <button class="btn" onclick="saveMapping()">Save & Confirm</button>
  </div>
</div>

<div class="main">
  <!-- PDF Render Area -->
  <div class="pdf-container" id="pdfContainer">
    <!-- Pages injected here -->
  </div>

  <!-- Sidebar Form -->
  <div class="sidebar">
    <div class="sidebar-header">
      Select a field to edit its AI instruction.
    </div>
    <ul class="fields-list" id="fieldsList">
      <!-- Items injected here -->
    </ul>
  </div>
</div>

<script>
  const token = "{{ token }}";
  const pdfId = "{{ pdf_id }}";
  let pdfDoc = null;
  let fieldsData = [];
  let currentScale = 1.0;

  async function init() {
    try {
      // 1. Load CSV Data
      const csvRes = await fetch(`/api/mappings/${token}/${pdfId}/rich`);
      if(!csvRes.ok) throw new Error("Failed to load CSV");
      const csvText = await csvRes.text();
      fieldsData = parseCSV(csvText);
      renderSidebar();

      // 2. Load PDF
      const loadingTask = pdfjsLib.getDocument(`/api/mappings/${token}/${pdfId}/annotated`);
      pdfDoc = await loadingTask.promise;
      renderPDF();
    } catch (e) {
      alert("Error initializing: " + e.message);
      console.error(e);
    }
  }

  // --- Robust CSV Parser (Fixes NaN and Quotes) ---
  function parseCSV(text) {
    // 1. Split into lines, handle CRLF
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (lines.length === 0) return [];

    // 2. Extract Headers (Trim whitespace!)
    const headers = parseLine(lines[0]).map(h => h.trim());

    const result = [];
    for (let i = 1; i < lines.length; i++) {
      const currentLine = parseLine(lines[i]);
      // Skip malformed lines
      if (currentLine.length < headers.length) continue;

      const obj = {};
      headers.forEach((h, index) => {
        obj[h] = currentLine[index] || "";
      });

      // Type conversion
      // Use logical defaults if parsing fails
      obj.row = parseInt(obj.row) || 0;
      obj.page = parseInt(obj.page) || 1;
      obj.x1 = parseFloat(obj.x1) || 0;
      obj.y1 = parseFloat(obj.y1) || 0;
      obj.x2 = parseFloat(obj.x2) || 0;
      obj.y2 = parseFloat(obj.y2) || 0;

      result.push(obj);
    }
    return result;
  }

  // Parse a single CSV line handling quotes and commas
  function parseLine(text) {
    const res = [];
    let entry = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const char = text[i];

      if (char === '"') {
        // Handle escaped quote ("") vs end quote
        if (inQuotes && text[i + 1] === '"') {
          entry += '"';
          i++; // Skip next quote
        } else {
          inQuotes = !inQuotes; // Toggle
        }
      } else if (char === ',' && !inQuotes) {
        res.push(entry);
        entry = "";
      } else {
        entry += char;
      }
    }
    res.push(entry);
    return res;
  }

  // --- PDF Rendering ---
  function changeZoom(delta) {
    currentScale = Math.max(0.5, Math.min(3.0, currentScale + delta));
    renderPDF();
  }

  function resetZoom() {
    currentScale = 1.0;
    renderPDF();
  }

  async function renderPDF() {
    const container = document.getElementById('pdfContainer');
    container.innerHTML = '';

    for (let num = 1; num <= pdfDoc.numPages; num++) {
      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: currentScale });

      // Create Wrapper
      const wrapper = document.createElement("div");
      wrapper.className = "pdf-page-wrapper";
      wrapper.style.width = viewport.width + "px";
      wrapper.style.height = viewport.height + "px";

      // Canvas
      const canvas = document.createElement("canvas");
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      wrapper.appendChild(canvas);

      // Async render
      page.render({ canvasContext: canvas.getContext('2d'), viewport });

      // Render Overlays
      renderOverlays(wrapper, num, viewport);

      container.appendChild(wrapper);
    }
  }

  function renderOverlays(pageDiv, pageNum, viewport) {
    // Filter fields for this page
    const pageFields = fieldsData.filter(f => f.page === pageNum);

    pageFields.forEach(f => {
      // Logic: The Coordinates in CSV are from PyMuPDF (Unscaled points).
      // PDF.js Viewport handles the scaling (Points -> Pixels * Zoom).
      // We assume standard PDF coordinates (Bottom-Left origin) BUT...
      // PyMuPDF usually extracts Rects as (x0, y0, x1, y1) with Top-Left origin
      // relative to the unscaled page.
      // PDF.js default viewport usually assumes Top-Left origin for HTML overlay
      // compatibility. Let's try direct scaling first.

      const x = f.x1 * currentScale;
      const y = f.y1 * currentScale;
      const w = (f.x2 - f.x1) * currentScale;
      const h = (f.y2 - f.y1) * currentScale;

      const box = document.createElement("div");
      box.className = "field-box";
      box.style.left = x + "px";
      box.style.top = y + "px";
      box.style.width = w + "px";
      box.style.height = h + "px";
      box.id = `box-${f.row}`;

      box.innerHTML = `<div class="field-badge">${f.row}</div>`;

      box.onclick = (e) => {
        e.stopPropagation();
        selectField(f.row);
      };

      pageDiv.appendChild(box);
    });
  }

  // --- Sidebar Logic ---
  function renderSidebar() {
    const list = document.getElementById("fieldsList");
    list.innerHTML = '';

    // Sort by Page then Row
    fieldsData.sort((a,b) => a.page - b.page || a.row - b.row);

    fieldsData.forEach(f => {
      const li = document.createElement("li");
      li.className = "field-item";
      li.id = `item-${f.row}`;

      const displayText = f.heading ? `${f.heading} / ${f.subheading}` : `(Field #${f.row})`;

      li.innerHTML = `
        <div class="field-meta">
          <span class="field-id">#${f.row}</span>
          <span>Page ${f.page}</span>
        </div>
        <div class="field-label">${displayText}</div>
        <textarea class="field-input" placeholder="Enter AI Description..."
          oninput="updateData(${f.row}, this.value)"
          onfocus="focusBox(${f.row})"
        >${f.rich_description || ''}</textarea>
      `;
      li.onclick = (e) => {
        // Only trigger select if not clicking the textarea
        if(e.target.tagName !== 'TEXTAREA') selectField(f.row);
      };
      list.appendChild(li);
    });
  }

  function focusBox(rowId) {
    // Highlight box without scrolling sidebar
    document.querySelectorAll('.field-box').forEach(el => el.classList.remove('active'));
    const box = document.getElementById(`box-${rowId}`);
    if (box) {
      box.classList.add('active');
      box.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function selectField(rowId) {
    // 1. Highlight Box
    focusBox(rowId);

    // 2. Highlight Sidebar & Focus Input
    document.querySelectorAll('.field-item').forEach(el => el.classList.remove('active'));
    const item = document.getElementById(`item-${rowId}`);
    if (item) {
      item.classList.add('active');
      item.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // const input = item.querySelector('textarea');
      // input.focus();
    }
  }

  function updateData(rowId, value) {
    const field = fieldsData.find(f => f.row === rowId);
    if (field) {
      field.rich_description = value;
    }
  }

  async function saveMapping() {
    const button = document.querySelector('.toolbar .btn:last-child');
    button.textContent = "Saving...";
    button.disabled = true;

    // Convert data back to CSV manually to handle quotes properly
    const headers = ["row", "heading", "subheading", "form_entry_description", "rich_description", "x1", "y1", "x2", "y2", "page"];

    let csvContent = headers.join(",") + "\n";

    fieldsData.forEach(row => {
      const line = headers.map(h => {
        let val = row[h] === undefined ? "" : String(row[h]);
        // Escape quotes: " -> "" and wrap in "..." if contains special chars
        if (val.search(/("|,|\n)/g) >= 0) {
          val = `"${val.replace(/"/g, '""')}"`;
        }
        return val;
      }).join(",");
      csvContent += line + "\n";
    });

    try {
      const res = await fetch(`/api/mappings/${token}/${pdfId}/save`, {
        method: "POST",
        headers: { "Content-Type": "text/csv" },
        body: csvContent
      });

      if (res.ok) {
        button.textContent = "Saved!";
        setTimeout(() => {
          button.textContent = "Save & Confirm";
          button.disabled = false;
          window.close();
        }, 1000);
      } else {
        throw new Error("Server returned error");
      }
    } catch (e) {
      alert("Error saving: " + e.message);
      button.textContent = "Save & Confirm";
      button.disabled = false;
    }
  }

  init();
</script>
</body>
</html>
